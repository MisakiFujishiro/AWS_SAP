# コスト最適化
## EC2のコスト

### Reserved Instance
1年、または3年の購入期間が必要。
支払いは前払いや毎月払いができる。

購入の際に対象のインスタンスタイプとRI数を指定する。
特定のインスタンスが無料で起動できるのはなく、対象となるインスタンスタイプのインスタンスが起動していると利用されていく。  
※正規化係数は、各インスタンスタイプに割り振られた値

無料枠全量の考え方は以下
> 購入インスタンスタイプの正規化係数 * RI数 * 365 * 24

利用される無料枠の考え方は以下
> 利用されているディスカウント対象のインスタンスタイプの正規化係数 * RI数 * 時間

#### 提供クラス
スタンダートとコンバーティブルから選択することができる。

スタンダートは、同じインスタンスファミリー内での変更が可能。ただし正規化係数が一致している必要がある。
コンバーティブルは、インスタンスファミリーについても変更が可能。ただし同等か上のレベルのみ適用可能。


### Savings Plan
Reserved Instanceと比較して、事前に決定することが少ない中でディスカウントを受けることができるメリットがある。
例えば、インスタンスタイプやリージョン、OSを選択することなく、割り引きを始めることができる。


### スポットインスタンス
各AZのインスタンスタイプの使用されていない量に応じて決定される料金で利用することができる。
ただし、使用量が上がってきた場合は、中断されてしまう可能性がある。

なので、中断が発生してもAppに影響がないようなユースケースで利用すること。

### スポットフリート
スポットインスタンスとオンデマンドインスタンスの組み合わせでフリートを構成する仕組みのこと。
コストを下げながら、事前に設定した構成を満たすように動く。例えばスポットインスタンスがダウンするタイミングになったら、自動でオンデマンドインスタンスを起動させて、設定した台数を満たすように動く。

### Dedicated Hosts
専用の物理サーバーを確保してEC2インスタンスを起動させることができる。ライセンス要件にまで対応できる。
追加の料金がかかるが、こちらについてもリザーブドインスタンスを指定することができる。

類似サービスのハードウェア専有はインスタンスの配置がコントロールできないなど、Dedicated Hostsの方がより専有の要件を満たしている。
ライセンス要件にも対応したい場合はDedicated Hostsで、専用物理サーバーの要件に答えるだけならハードウェア専有インスタンスが適切。具体的にはDedicated Hostsであれば再起動後も同じホストを利用するためにはアフィニティ（自然な引きつけられる力）を有効化することで、ライセンスを有効化できる。



## S3のコスト
S3の一覧

| 種類 | 耐久性 | 速度 | 特徴 |
|:------|:-------:|------:|------:|
| S3標準     | 3つのAZ       | 高スループット、低レイテンシー     | 標準     |
| S3 標準 – IA     | 3つのAZ       | 高スループット、低レイテンシー     | アクセスが少ない場合料金が安い     |
| S3 Intelligent-Tiering      | 3つのAZ       | 高スループット、低レイテンシー     | 自動でIAと標準を使い分ける     |
| S3 1 ゾーン – IA     | 1つのAZ       | 高スループット、低レイテンシー      | 可用性を落として費用を削減     |
| S3 Glacier Instant Retrieval     | 1つのAZに障害が発生しても復元可能       | 高スループット、低レイテンシー     | アクセスがほとんど無いがミリ秒単位のアクセスが必要     |
| S3 Glacier Flexible Retrieval (旧 S3 Glacier)     | 1つのAZに障害が発生しても復元可能       | 数分から数時間のアクセス時間     | ほぼ利用されないデータで即時性が求められないもの     |
| Amazon S3 Glacier Deep Archive     | 3つのAZ       | 取り出し時間は 12 時間以内     | 7～10 年以上データセットを保管するように設計     |

### S3 標準 vs IA
IAは保管費用が安い分、アクセス時のお金はかかる。
1ヶ月に1度なら、標準の方補が安い。

### S3 Intelligent-Tiering 
30日利用がないとIAへ、90日利用がないとアーカイブへ移動してくれる。

### S3リクエスタ支払い
S3へのリクエストした側にリクエスト料金とデータ転送料金を請求することができる。

支払いが関連するのでAWSアカウントからしかアクセスできなくなる。
リクエストヘッダーに必ず`x-amz-request-payer`を追加する必要があり、このリクエストヘッダーを持って支払いに了承したとして扱う。



## DynamoDBのコスト
DynamoDBのアイテム読み込みと書き込みには2つのモードがあり、それぞれでコストが異なる。  
継続的なリクエスト、緩やかな需要であれば、プロビジョンドキャパシティモードが良い。

プロビジョンドキャパシティモードで設定された数値を超えるリクエストが来てしまうとスロットリングが発生してしまいProvisionedThroughputExceededExceptionエラーが返される。
### オンデマンドモード
書き込みリクエストが発生するたびに料金が発生する。  
利用されていないタイミングでは、費用がかからないが、1回あたりの費用はプロビジョンドキャパシティモードより高い。
急なリクエスト増加にも対応可能。
### プロビジョンドキャパシティモード
1秒間の書き込み・読み込み回数・容量に対して設定するWCUとRCUを定義して時間当たりの費用が発生する。
利用されてない場合でも費用がかかる。WCUとRCUで捌き切れる範囲なら費用は安いが、急なリクエスト増加には耐えられない。

### DAX
VPC内部でDynamoDBのキャッシュとして利用することができ、数マイクロの応答が可能になる。
GETの処理に関して速度の改善とリクエスト数の低減の効果が期待できる。
作成されるノード単位で課金がかかる。



## その他
### リザーブドオプション
リザーブドオプションのあるサービス
- RDS
- ElastiCache
- Redshift
- OpenSearch Service

### コスト配分タグ
タグをサポートしているリソースに対してタグを適切に付与することで、Cost Explorerを利用した費用分析にタグを利用することができる。
タグの運用を正しくするために、OrganizationsタグポリシーやSCPを利用する。



## コスト管理
### AWS Compute Optimizer
EC2インスタンス、Auto Scalingグループ、ECSボリューム、Lambda関数、Fargateについて、使用しているメトリクスを分析して、リソースサイズが適切かをレポートしてくれる。  
コスト削減とパフォーマンスに関する推奨を提供してくれる。

### Cost Explorer
コストの使用状況に関して、グラフ分析することができる。
費用の予測をしてくれるので未来日まで含めてグラフを提示できる。

また、RIなどの使用状況と過去の実績に基づいた推奨事項を確認できる。


### Anomaly Detection
支払いパターンをモニタリングしながら異常なコストを検出することができる。

AWSサービス別やアカウント別、タグ別に対して異常値の検出をすることができる。

### AWS Cost and Usage Reports
コストと使用状況のレポートを有効化することで、詳細な課金情報をS3に書き出してくれる。
S3の情報をAthenaやQuickSightを利用して分析する。

### アラーム設定
アラーム設定は以下二つのサービスどちらかを利用することで設定することができる
- Budgets
- CloudWatch
#### AWS Budgets
アカウントやOrganizationsの予算を作成することができる
予算を超える見通しや実際に肥えた場合にアラートを発進することができる。

#### 請求アラーム
請求アラームを受け取るぷションを有効にすると、us-east-1のCloudWatchで請求アラームを設定できる。
請求額メトリクスに対してアラームを設定し通知を行うことができる。
